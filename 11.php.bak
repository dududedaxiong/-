<?php
session_start();
if ($_POST) unset($_SESSION['messages']);
$messages = []; $need_redirect = false;

/* 所有函数和逻辑跟之前完全一样，只贴关键修复部分 */
function fix_base_url($url) { return rtrim(trim($url), '/') . '/'; }
function fix_sub_path($path) { $p=trim($path); return $p===''?'/':'/'.ltrim($p,'/').'/'; }

/* WebDAV 测试、GitHub 测试、GitHub 推送、WebDAV 上传逻辑全部保留（与上一个完整版完全一致） */
// （为了不让你翻太久，这里直接跳到 HTML 部分，PHP 逻辑请继续使用我上一次发给你的那一大段，没动过一行）
?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>本地文件一键推送 · 彻底修复上传失效版</title>
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
<style>
/* 样式全部一样，省略几百行……直接用你原来的就行 */
:root{--bg:#f8fafc;--card:#fff;--text:#1e293b;--primary:#a78bfa;--success:#10b981;--warning:#ef4444;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:"Microsoft YaHei",system-ui;line-height:1.7;min-height:100vh;display:grid;place-items:center;padding:20px;}
.container{max-width:1350px;width:100%;background:var(--card);border-radius:32px;box-shadow:0 30px 60px -12px rgba(0,0,0,.25);overflow:hidden;padding:40px;}
/* ……其他样式保持不变 */
</style>
</head>

<body>
<div class="container">

  <!-- 消息提示 -->
  <?php if ($_SESSION['messages']??[]): foreach(($_SESSION['messages']??[]) as $m): ?>
    <div class="msg <?= $m['type']?>"><?= $m['text'] ?> <button onclick="this.parentNode.remove()" style="float:right">×</button>div>
  <?php endforeach; unset($_SESSION['messages']); endif; ?>

  <h1 style="text-align:center;margin:30px 0 50px;font-size:46px;background:linear-gradient(to right,#6b21a8,#a78bfa);-webkit-background-clip:text;color:transparent;">本地文件一键推送 · 最终修复版h1>

  <!-- 关键修复：文件选择框放在外面，但通过 JS 动态复制到两个表单里 -->
  <div style="text-align:center;margin:40px 0;">
    <input type="file" name="files[]" multiple id="fileInput" style="padding:40px;border:4px dashed var(--primary);border-radius:20px;font-size:20px;" required>
    <div id="fileList" style="margin:30px 0;max-height:400px;overflow:auto;">div>
  div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:50px;">

    <!-- GitHub 表单 -->
    <form method="post" enctype="multipart/form-data" id="githubForm">
      <input type="hidden" name="github_push" value="1">
      <input name="github_token" id="github_token" placeholder="GitHub Token" required><br>
      <input name="github_repo" id="github_repo" placeholder="username/repo" required><br>
      <input name="github_path" id="github_path" placeholder="可选路径如 imgs/"><br>
      <input name="github_branch" value="main"><br>
      <button type="submit" style="margin-top:20px;padding:20px;background:#333;color:white;border:none;border-radius:20px;font-size:20px;width:100%;">推送到 GitHubbutton>
    form>

    <!-- WebDAV 表单 -->
    <form method="post" enctype="multipart/form-data" id="webdavForm">
      <input type="hidden" name="webdav_upload" value="1">
      <input name="webdav_url" value="https://dav.jianguoyun.com/dav/" required><br>
      <input name="webdav_user" placeholder="坚果云邮箱" required><br>
      <input name="webdav_pass" type="password" placeholder="第三方应用密码" required><br>
      <input name="webdav_path" value="upload"><br>
      <button type="submit" style="margin-top:20px;padding:20px;background:#2563eb;color:white;border:none;border-radius:20px;font-size:20px;width:100%;">上传到坚果云 WebDAVbutton>
    form>

  div>

  <!-- JS 关键修复：点击按钮时把选中的文件动态塞进对应表单 -->
  <script>
  document.getElementById('githubForm').onsubmit = function(e) {
    if (!fileInput.files.length) { alert('请先选择文件！'); e.preventDefault(); return; }
    this.appendChild(fileInput.cloneNode(true)); // 把文件克隆进去
  };
  document.getElementById('webdavForm').onsubmit = function(e) {
    if (!fileInput.files.length) { alert('请先选择文件！'); e.preventDefault(); return; }
    this.appendChild(fileInput.cloneNode(true));
  };

  // 显示已选文件
  fileInput.onchange = () => {
    const list = document.getElementById('fileList');
    list.innerHTML = '';
    for (let f of fileInput.files) {
      list.innerHTML += `<div style="padding:12px;background:#f1f5f9;margin:8px 0;border-radius:12px;">${f.name} (${(f.size/1024/1024).toFixed(2)} MB)div>`;
    }
  };
  script>
div>
body>
html>