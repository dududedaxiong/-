<?php
session_start();
if ($_POST) unset($_SESSION['messages']);
$messages = [];
$need_redirect = false;

/* ==================== 工具函数 ==================== */
function fix_base_url($url) { return rtrim(trim($url), '/') . '/'; }
function fix_sub_path($path) { $p=trim($path); return $p==='' ? '/' : '/'.ltrim($p,'/').'/'; }

/* ==================== WebDAV 测试 ==================== */
if (isset($_POST['action']) && $_POST['action'] === 'webdav_test') {
    $url  = fix_base_url($_POST['webdav_url']);
    $user = trim($_POST['webdav_user'] ?? '');
    $pass = $_POST['webdav_pass'] ?? '';
    $auth = (!empty($user) && !empty($pass)) ? 'Basic ' . base64_encode($user . ':' . $pass) : '';

    $ctx = stream_context_create([
        'http' => [
            'method'        => 'OPTIONS',
            'header'        => ($auth ? "Authorization: $auth\r\n" : "") . "User-Agent: PHP-Test\r\n",
            'timeout'       => 15,
            'ignore_errors' => true
        ]
    ]);

    @file_get_contents($url, false, $ctx);
    $code = '000';
    if (isset($http_response_header[0])) {
        preg_match('/\s(\d{3})\s/', $http_response_header[0], $m);
        $code = $m[1] ?? '000';
    }

    if ($code === '401') {
        $messages[] = ['type'=>'warning','text'=>'密码错误！必须使用「第三方应用密码」<br><a href="https://www.jianguoyun.com/#/profile/thirdparty" target="_blank">点此生成专用密码</a>'];
    } elseif (in_array($code, ['200','201','204','207','404'])) {
        $messages[] = ['type'=>'success','text'=>"WebDAV 连接成功！状态码 $code<br>地址已修复为：<br><code style='background:#dcfce7;padding:8px 16px;border-radius:8px;display:block;margin-top:8px;'>$url</code>"];
    } else {
        $messages[] = ['type'=>'warning','text'=>"连接失败！状态码 $code"];
    }
    $need_redirect = true;
}

/* ==================== GitHub 测试 ==================== */
if (isset($_POST['action']) && $_POST['action'] === 'github_test') {
    $token = trim($_POST['github_token'] ?? '');
    $repo  = trim($_POST['github_repo'] ?? '');

    if (empty($token)) {
        $messages[] = ['type'=>'warning','text'=>'GitHub Token 不能为空！'];
    } elseif (empty($repo)) {
        $messages[] = ['type'=>'warning','text'=>'仓库名不能为空！'];
    } else {
        $ctx = stream_context_create([
            'http' => [
                'method'  => 'GET',
                'header'  => "Authorization: token $token\r\nUser-Agent: PHP-Test\r\n",
                'timeout' => 15,
                'ignore_errors' => true
            ]
        ]);

        $response = @file_get_contents("https://api.github.com/repos/$repo", false, $ctx);
        $code = '000';
        if (isset($http_response_header[0])) {
            preg_match('/\s(\d{3})\s/', $http_response_header[0], $m);
            $code = $m[1] ?? '000';
        }

        if ($code === '200') {
            $data = json_decode($response, true);
            $messages[] = ['type'=>'success','text'=>
                "GitHub Token 完全有效！<br>".
                "仓库：<code>{$data['full_name']}</code><br>".
                "默认分支：<code>{$data['default_branch']}</code><br>".
                "权限：可读写（上传将成功）"
            ];
        } elseif ($code === '401') {
            $messages[] = ['type'=>'warning','text'=>'Token 无效、已过期或权限不足！<br>请重新生成 Personal Access Token（建议勾选 repo 权限）'];
        } elseif ($code === '404') {
            $messages[] = ['type'=>'warning','text'=>'仓库不存在，或 Token 没有访问权限！<br>检查仓库名是否正确（username/repo）'];
        } else {
            $messages[] = ['type'=>'warning','text'=>"GitHub 连接失败，状态码：$code"];
        }
    }
    $need_redirect = true;
}

/* ==================== GitHub 推送 + 自动生成订阅地址 ==================== */
if (isset($_POST['github_push']) && !empty($_FILES['files']['name'][0])) {
    $token  = trim($_POST['github_token'] ?? '');
    $repo   = trim($_POST['github_repo'] ?? '');
    $branch = trim($_POST['github_branch'] ?? 'main');
    $path   = trim($_POST['github_path'] ?? '');

    if (empty($token) || empty($repo)) {
        $messages[] = ['type'=>'warning','text'=>'GitHub Token 和仓库不能为空！'];
    } else {
        $success = $failed = 0;
        $links = [];
        $subUrls = [];

        for ($i = 0; $i < count($_FILES['files']['name']); $i++) {
            if ($_FILES['files']['error'][$i] !== UPLOAD_ERR_OK) continue;

            $fileName   = basename($_FILES['files']['name'][$i]);
            $remotePath = ltrim(($path ? $path . '/' : '') . $fileName, '/');
            $content    = base64_encode(file_get_contents($_FILES['files']['tmp_name'][$i]));

            // 获取 SHA（用于更新文件）
            $shaCtx = stream_context_create(['http'=>['header'=>"Authorization: token $token\r\nUser-Agent: PHP"]]);
            $info   = @file_get_contents("https://api.github.com/repos/$repo/contents/$remotePath?ref=$branch", false, $shaCtx);
            $sha    = '';
            if ($info !== false) {
                $data = json_decode($info, true);
                if (isset($data['sha'])) $sha = $data['sha'];
            }

            $payload = [
                'message' => "Upload $fileName - " . date('Y-m-d H:i:s'),
                'content' => $content,
                'branch'  => $branch
            ];
            if ($sha) $payload['sha'] = $sha;

            $ctx = stream_context_create([
                'http' => [
                    'method'  => 'PUT',
                    'header'  => "Authorization: token $token\r\nUser-Agent: PHP\r\nContent-Type: application/json",
                    'content' => json_encode($payload),
                    'timeout' => 30
                ]
            ]);

            $resp = @file_get_contents("https://api.github.com/repos/$repo/contents/$remotePath", false, $ctx);

            if ($resp !== false) {
                $success++;
                $rawUrl = "https://raw.githubusercontent.com/$repo/$branch/$remotePath";
                $links[] = "<code>$fileName</code> → <a href='$rawUrl' target='_blank'>$rawUrl</a>";

                // 自动识别常见订阅文件
                $ext = strtolower(pathinfo($fileName, PATHINFO_EXTENSION));
                if (in_array($ext, ['txt','yaml','yml','json','list','conf','dat','m3u','clash','sub'])) {
                    $subUrls[] = $rawUrl;
                }
            } else {
                $failed++;
            }
        }

        $text = "GitHub 推送完成！成功 $success 个" . ($failed ? "，失败 $failed 个" : "");
        if (!empty($links)) $text .= "<br><br>文件直链：<br>" . implode('<br>', $links);

        if (!empty($subUrls)) {
            $subLink = implode("\n", $subUrls);
            $text .= "<br><br><strong style='color:#16a34a;font-size:18px;'>订阅地址（自动识别，一键复制）：</strong><br>
            <textarea id='subBox' style='width:100%;height:100px;padding:15px;border-radius:12px;background:#f0fdf4;border:2px solid #86efac;margin:10px 0;font-size:15px;'>$subLink</textarea>
            <button onclick='document.getElementById(\"subBox\").select();document.execCommand(\"copy\");alert(\"已复制到剪贴板！\")' 
            style='padding:12px 30px;background:#16a34a;color:white;border:none;border-radius:12px;cursor:pointer;font-size:16px;'>一键复制全部订阅链接</button>";
        }

        $messages[] = ['type'=>'success','text'=>$text];
    }
    $need_redirect = true;
}

/* ==================== WebDAV 上传 ==================== */
if (isset($_POST['webdav_upload']) && !empty($_FILES['files']['name'][0])) {
    $base_url = fix_base_url($_POST['webdav_url']);
    $sub_path = fix_sub_path($_POST['webdav_path'] ?? '');
    $user     = trim($_POST['webdav_user'] ?? '');
    $pass     = $_POST['webdav_pass'] ?? '';
    $auth     = (!empty($user) && !empty($pass)) ? 'Basic ' . base64_encode($user . ':' . $pass) : '';

    $success = $failed = 0;
    $details = [];

    for ($i = 0; $i < count($_FILES['files']['name']); $i++) {
        if ($_FILES['files']['error'][$i] !== UPLOAD_ERR_OK) {
            $failed++;
            continue;
        }

        $fileName = $_FILES['files']['name'][$i];
        $tmpFile  = $_FILES['files']['tmp_name'][$i];
        $content  = file_get_contents($tmpFile);
        $size     = strlen($content);
        $finalUrl = $base_url . ltrim($sub_path . $fileName, '/');

        // 自动创建目录
        $parts = explode('/', dirname($sub_path . $fileName));
        $cur = $base_url;
        foreach ($parts as $p) {
            if (!$p || $p === '.') continue;
            $cur .= $p . '/';
            $mkCtx = stream_context_create([
                'http' => [
                    'method'        => 'MKCOL',
                    'header'        => "Content-Length: 0\r\n" . ($auth ? "Authorization: $auth\r\n" : ''),
                    'ignore_errors' => true
                ]
            ]);
            @file_get_contents($cur, false, $mkCtx);
        }

        $headers = [
            'Content-Type: application/octet-stream',
            'Content-Length: ' . $size,
            'Expect: ',
            'User-Agent: PHP-WebDAV-2025'
        ];
        if ($auth) $headers[] = "Authorization: $auth";

        $ctx = stream_context_create([
            'http' => [
                'method'  => 'PUT',
                'header'  => implode("\r\n", $headers) . "\r\n",
                'content' => $content,
                'timeout' => 300,
                'ignore_errors' => true
            ]
        ]);

        @file_put_contents($finalUrl, $content, false, $ctx);

        $code = '000';
        if (isset($http_response_header[0])) {
            preg_match('/\s(\d{3})\s/', $http_response_header[0], $m);
            $code = $m[1] ?? '000';
        }

        if (in_array($code, ['201','204'])) {
            $success++;
            $details[] = "<code>$fileName</code> → <span style='color:#10b981'>成功</span><br><a href='$finalUrl' target='_blank'>$finalUrl</a>";
        } else {
            $failed++;
            $details[] = "<code>$fileName</code> → <span style='color:#ef4444'>失败 ($code)</span>";
        }
    }

    $text = "WebDAV 上传完成！成功 <strong>$success</strong> 个";
    if ($failed) $text .= "，失败 <strong>$failed</strong> 个";
    $text .= "<br><br>详细结果：<br>" . implode('<br>', $details);
    $messages[] = ['type'=> $failed ? 'warning' : 'success', 'text'=>$text];
    $need_redirect = true;
}

/* ==================== 重定向 ==================== */
if ($need_redirect && !empty($messages)) {
    $_SESSION['messages'] = $messages;
    header("Location: " . basename(__FILE__));
    exit;
}
$messages = $_SESSION['messages'] ?? [];
unset($_SESSION['messages']);
?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>本地文件一键推送 · 实时预览 + 订阅地址一键复制 · 2025终极版</title>
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
<style>
:root{--bg:#f8fafc;--card:#fff;--text:#1e293b;--primary:#a78bfa;--success:#10b981;--warning:#ef4444;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:"Microsoft YaHei",system-ui;line-height:1.7;min-height:100vh;display:grid;place-items:center;padding:20px;}
.container{max-width:1450px;width:100%;background:var(--card);border-radius:32px;box-shadow:0 30px 60px -12px rgba(0,0,0,.25);overflow:hidden;}
.header{background:linear-gradient(135deg,#ddd6fe,#c4b5fd);padding:60px 40px;text-align:center;}
.header h1{font-size:46px;font-weight:900;background:linear-gradient(to right,#6b21a8,#a78bfa);-webkit-background-clip:text;color:transparent;}
.body{padding:50px 70px;}
.msg{padding:20px 30px;border-radius:20px;margin:20px 0;font-weight:600;position:relative;}
.msg.success{background:#dcfce7;color:#166534;border:2px solid #86efac;}
.msg.warning{background:#fee2e2;color:#991b1b;border:2px solid #fca5a5;}
.accordion{margin:40px 0;background:rgba(167,139,250,.08);border-radius:20px;overflow:hidden;}
.accordion-header{padding:24px 32px;cursor:pointer;font-size:22px;font-weight:800;display:flex;justify-content:space-between;align-items:center;background:rgba(167,139,250,.15);}
.accordion-header i{transition:.3s;font-size:28px;}
.accordion-header.active i{transform:rotate(180deg);}
.accordion-body{padding:32px;display:none;background:var(--card);}
.accordion-body.show{display:block;}
input[type=file]{width:100%;padding:40px;border:4px dashed var(--primary);border-radius:20px;text-align:center;font-size:20px;background:rgba(167,139,250,.05);}
input{width:100%;padding:18px 24px;border:2px solid #e2e8f0;border-radius:18px;font-size:17px;margin:10px 0;}
input:focus{border-color:var(--primary);box-shadow:0 0 0 6px rgba(167,139,250,.18);}
.btn{padding:20px 40px;border:none;border-radius:20px;font-size:20px;font-weight:800;cursor:pointer;transition:.4s;margin:10px;}
.github-btn{background:#1f2937;color:white;}
.webdav-btn{background:#3b82f6;color:white;}
.test-btn{background:#f97316;color:white;width:100%;margin-top:15px;}
.btn:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(0,0,0,.3);}
#uploadActions{margin:50px 0;text-align:center;}
#fileList{margin:40px 0;display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:25px;}
.preview-box{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:20px;}
.preview-box img,.preview-box video{max-width:100%;border-radius:12px;display:block;margin:0 auto;}
.preview-box pre{margin:0;background:#1e1e1e;color:#d4d4d4;padding:16px;border-radius:12px;overflow:auto;font-size:14px;}
.file-name{font-weight:800;font-size:18px;margin-bottom:12px;color:var(--primary);}
.progress{margin:20px auto;width:80%;height:12px;background:#e5e7eb;border-radius:6px;overflow:hidden;display:none;}
.progress-bar{height:100%;background:var(--primary);width:0;transition:width .4s;}
.tip{background:#fef3c7;padding:20px;border-radius:16px;margin-top:30px;text-align:center;}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>本地文件一键推送</h1>
    <p>实时预览 + GitHub 自动生成订阅地址 + 双测试 · 2025 终极版</p>
  </div>

  <div class="body">

    <?php foreach($messages as $m): ?>
      <div class="msg <?= $m['type']==='warning' ? 'warning' : 'success' ?>">
        <?= $m['text'] ?>
        <button onclick="this.parentElement.remove()" style="float:right;padding:6px 14px;background:rgba(0,0,0,0.2);border:none;border-radius:8px;cursor:pointer;">×</button>
      </div>
    <?php endforeach; ?>

    <div class="accordion">
      <div class="accordion-header active" onclick="toggleAccordion(this)">
        <span>选择本地文件（支持多选）</span><i class="ri-arrow-down-s-line"></i>
      </div>
      <div class="accordion-body show">
        <input type="file" multiple id="fileInput">
        <div id="fileList"></div>
      </div>
    </div>

    <div id="uploadActions">
      <button type="button" class="btn github-btn" id="githubBtn">推送到 GitHub</button>
      <button type="button" class="btn webdav-btn" id="webdavBtn">上传到坚果云 WebDAV</button>
      <div class="progress" id="progress"><div class="progress-bar" id="bar"></div></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:50px;margin-top:30px;">
      <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)"><span>GitHub 配置</span><i class="ri-arrow-down-s-line"></i></div>
        <div class="accordion-body">
          <form id="githubForm" method="post" enctype="multipart/form-data">
            <input type="hidden" name="github_push" value="1">
            <input name="github_token" id="github_token" placeholder="GitHub Token (ghp_ 或 gho_)" required>
            <input name="github_repo" id="github_repo" placeholder="仓库：username/repo" required>
            <input name="github_path" id="github_path" placeholder="子目录（可选，如 subs/）">
            <input name="github_branch" id="github_branch" value="main" placeholder="分支">
          </form>
          <form method="post">
            <input type="hidden" name="action" value="github_test">
            <input type="hidden" name="github_token" id="test_github_token">
            <input type="hidden" name="github_repo" id="test_github_repo">
            <button type="submit" class="btn test-btn" style="background:#333;">测试 GitHub Token 和仓库</button>
          </form>
        </div>
      </div>

      <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)"><span>坚果云 WebDAV 配置</span><i class="ri-arrow-down-s-line"></i></div>
        <div class="accordion-body">
          <form id="webdavForm" method="post" enctype="multipart/form-data">
            <input type="hidden" name="webdav_upload" value="1">
            <input name="webdav_url" id="webdav_url" value="https://dav.jianguoyun.com/dav/" required>
            <input name="webdav_user" id="webdav_user" placeholder="坚果云注册邮箱" required>
            <input name="webdav_pass" id="webdav_pass" type="password" placeholder="第三方应用密码（不是登录密码！）" required>
            <input name="webdav_path" id="webdav_path" value="upload" placeholder="子目录">
          </form>
          <form method="post">
            <input type="hidden" name="action" value="webdav_test">
            <input type="hidden" name="webdav_url" id="test_url">
            <input type="hidden" name="webdav_user" id="test_user">
            <input type="hidden" name="webdav_pass" id="test_pass">
            <button type="submit" class="btn test-btn">测试 WebDAV 连接</button>
          </form>
        </div>
      </div>
    </div>

    <div class="tip">
      <b>使用方法：</b> php -S 0.0.0.0:8080 → 浏览器访问 http://127.0.0.1:8080/11.php
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script>
// 实时预览
// 实时预览 - 改为点击显示
const fileInput = document.getElementById('fileInput');
const fileList  = document.getElementById('fileList');

fileInput.onchange = () => {
  fileList.innerHTML = '';
  const files = Array.from(fileInput.files);

  files.forEach((file, index) => {
    const box = document.createElement('div');
    box.className = 'preview-box';
    box.style.cursor = 'pointer';

    const name = document.createElement('div');
    name.className = 'file-name';
    name.textContent = file.name + ' (' + (file.size/1024/1024).toFixed(2) + ' MB)';
    box.appendChild(name);

    // 点击打开预览窗口
    box.onclick = () => showPreview(file, index);
    fileList.appendChild(box);
  });
};
function showPreview(file, index) {
  const ext = file.name.split('.').pop().toLowerCase();
  const reader = new FileReader();

  reader.onload = e => {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.7);display:flex;align-items:center;
      justify-content:center;z-index:9999;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
      background:white;border-radius:20px;padding:0;
      max-width:900px;width:90%;max-height:85vh;overflow:hidden;
      position:relative;display:flex;flex-direction:column;
    `;

    // 顶部栏：关闭按钮(左) + 文件名(右)
    const topBar = document.createElement('div');
    topBar.style.cssText = `
      display:flex;justify-content:space-between;align-items:center;
      padding:20px 30px;background:#f8fafc;border-bottom:2px solid #e2e8f0;
      flex-shrink:0;
    `;

    const closeBtn = document.createElement('button');
    closeBtn.textContent = '✕ 关闭';
    closeBtn.style.cssText = `
      padding:10px 20px;background:#ef4444;color:white;border:none;
      border-radius:10px;cursor:pointer;font-weight:600;font-size:16px;
      flex-shrink:0;
    `;
    closeBtn.onclick = () => modal.remove();
    topBar.appendChild(closeBtn);

    const fileName = document.createElement('div');
    fileName.style.cssText = `
      flex:1;margin:0 20px;text-align:right;font-weight:700;font-size:18px;
      color:#1e293b;overflow:hidden;white-space:nowrap;
      ${file.name.length > 30 ? 'animation:scroll-text 10s infinite linear;' : ''}
    `;
    fileName.textContent = file.name;
    topBar.appendChild(fileName);

    content.appendChild(topBar);

    // 添加长文件名滚动动画
    if (!document.getElementById('scroll-style')) {
      const style = document.createElement('style');
      style.id = 'scroll-style';
      style.textContent = `
        @keyframes scroll-text {
          0% { transform:translateX(0); }
          50% { transform:translateX(-100%); }
          50.1% { transform:translateX(100%); }
          100% { transform:translateX(100%); }
        }
      `;
      document.head.appendChild(style);
    }

    // 预览内容区域（可滚动）
    const previewArea = document.createElement('div');
    previewArea.style.cssText = `
      flex:1;overflow:auto;padding:30px;background:white;
    `;

    // 根据文件类型生成预览内容
    if (['jpg','jpeg','png','gif','webp','bmp','svg'].includes(ext)) {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.cssText = 'max-width:100%;border-radius:12px;';
      previewArea.appendChild(img);
    } else if (['mp4','webm','ogg','mov','avi'].includes(ext)) {
      const video = document.createElement('video');
      video.src = e.target.result;
      video.controls = true;
      video.style.cssText = 'max-width:100%;border-radius:12px;';
      previewArea.appendChild(video);
    } else if (['txt','js','json','html','css','php','md','yaml','yml','xml','log','conf'].includes(ext)) {
      const pre = document.createElement('pre');
      const code = document.createElement('code');
      code.textContent = e.target.result;
      code.className = 'language-' + (ext==='md'?'markdown':ext);
      pre.style.cssText = 'margin:0;background:#1e1e1e;color:#d4d4d4;padding:20px;border-radius:12px;';
      pre.appendChild(code);
      previewArea.appendChild(pre);
      setTimeout(() => Prism.highlightElement(code), 50);
    } else {
      const p = document.createElement('p');
      p.textContent = '不支持预览 · 类型:' + ext.toUpperCase();
      p.style.cssText = 'color:#94a3b8;font-size:16px;';
      previewArea.appendChild(p);
    }

    content.appendChild(previewArea);
    modal.appendChild(content);
    
    // 点击外部关闭
    modal.onclick = (e) => {
      if (e.target === modal) modal.remove();
    };
    document.body.appendChild(modal);
  };

  // 根据文件类型选择读取方式
  if (['txt','js','json','html','css','php','md','yaml','yml','xml','log','conf'].includes(ext)) {
    reader.readAsText(file);
  } else {
    reader.readAsDataURL(file);
  }
}
// 上传修复（彻底解决文件不提交问题）
function submitWithFiles(formId) {
  if (!fileInput.files.length) return alert('请先选择文件！');
  const form = document.getElementById(formId);
  const dt = new DataTransfer();
  Array.from(fileInput.files).forEach(f => dt.items.add(f));
  const clone = document.createElement('input');
  clone.type = 'file';
  clone.name = 'files[]';
  clone.multiple = true;
  clone.files = dt.files;
  form.appendChild(clone);
  form.submit();
}
document.getElementById('githubBtn').onclick = () => submitWithFiles('githubForm');
document.getElementById('webdavBtn').onclick = () => submitWithFiles('webdavForm');

// 测试按钮
document.querySelectorAll('form:not(#githubForm):not(#webdavForm) button[type="submit"]').forEach(btn => {
  btn.onclick = e => {
    e.preventDefault();
    const form = btn.closest('form');
    if (form.querySelector('#test_github_token')) {
      document.getElementById('test_github_token').value = document.getElementById('github_token').value;
      document.getElementById('test_github_repo').value = document.getElementById('github_repo').value;
    } else {
      document.getElementById('test_url').value = document.getElementById('webdav_url').value;
      document.getElementById('test_user').value = document.getElementById('webdav_user').value;
      document.getElementById('test_pass').value = document.getElementById('webdav_pass').value;
    }
    form.submit();
  };
});

function toggleAccordion(el) {
  el.classList.toggle('active');
  el.nextElementSibling.classList.toggle('show');
}

// 记住配置
['github_token','github_repo','github_path','github_branch',
 'webdav_url','webdav_user','webdav_pass','webdav_path'].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.value = localStorage.getItem(id) || el.value || '';
    el.oninput = () => localStorage.setItem(id, el.value);
  }
});
</script>
</body>
</html>